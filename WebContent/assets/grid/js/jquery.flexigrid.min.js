
(function($){$.addFlex=function(t,p){if(t.grid)return false;p=$.extend({height:'auto',width:'auto',striped:true,novstripe:false,minwidth:30,minheight:80,resizable:false,url:false,method:'POST',dataType:'json',errormsg:i18n_flexigrid_queryFail,usepager:false,nowrap:true,sortorder:'asc',page:1,total:1,useRp:true,rp:20,rpOptions:[10,20,50,100],title:false,pagestat:i18n_flexigrid_recordDisplayFromTo,procmsg:i18n_flexigrid_loading,query:'',qtype:'',qop:"Eq",nomsg:i18n_flexigrid_noRecord,minColToggle:1,showToggleBtn:true,hideOnSubmit:true,showTableToggleBtn:false,autoload:true,blockOpacity:0.5,onToggleCol:false,onChangeSort:false,onSuccess:false,onSubmit:false,showcheckbox:false,checkboxName:'flexigridCheckbox',showradio:false,radioName:'flexigridRadio',rowhandler:false,rowbinddata:false,extParam:{},gridClass:"cbit-grid",numCheckBoxTitle:'',onrowchecked:false,isColSel:true,isDragCol:true,m_length:30},p);$(t).show().attr({cellPadding:0,cellSpacing:0,border:0}).removeAttr('width');var g={hset:{},rePosDrag:function(){var cdleft=0-this.hDiv.scrollLeft;if(this.hDiv.scrollLeft>0)cdleft-=Math.floor(p.cgwidth/2);$(g.cDrag).css({top:g.hDiv.offsetTop+1});var cdpad=this.cdpad;$('div',g.cDrag).hide();var i=0;var m=$.browser.mozilla?0:($.browser.chrome?1:1);$('thead tr:first th:visible',this.hDiv).each(function(){if($(this).css("display")=="none"){return;}
var n=i;var cdpos=parseInt($('div',this).width());var ppos=cdpos;if(cdleft==0)
cdleft-=Math.floor(p.cgwidth/2);cdpos=cdpos+cdleft+cdpad;$('div:eq('+n+')',g.cDrag).css({'left':cdpos-m*n+1-m+'px'}).show();cdleft=cdpos;i++;});},fixHeight:function(newH){newH=false;if(!newH)newH=$(g.bDiv).height();var hdHeight=$(this.hDiv).height();$('div',this.cDrag).each(function(){$(this).height(newH+hdHeight);});var nd=parseInt($(g.nDiv).height());if(nd>=newH&&newH!=0)
$(g.nDiv).height(newH).width(200);else
$(g.nDiv).height('auto').width('auto');$(g.block).css({height:newH,marginBottom:(newH*-1)});var hrH=g.bDiv.offsetTop+newH;if(p.height!='auto'&&p.resizable)hrH=g.vDiv.offsetTop;$(g.rDiv).css({height:hrH});},dragStart:function(dragtype,e,obj){if(dragtype=='colresize')
{$(g.nDiv).hide();$(g.nBtn).hide();var n=$('div',this.cDrag).index(obj);var ow=$('th:visible:eq('+n+') div',this.hDiv).width();$(obj).addClass('dragging').siblings().hide();$(obj).prev().addClass('dragging').show();this.colresize={startX:e.pageX,ol:parseInt(obj.style.left),ow:ow,n:n};$('body').css('cursor','col-resize');}
else if(dragtype=='vresize')
{var hgo=false;$('body').css('cursor','row-resize');if(obj){hgo=true;$('body').css('cursor','col-resize');}
this.vresize={h:p.height,sy:e.pageY,w:p.width,sx:e.pageX,hgo:hgo};}
else if(dragtype=='colMove')
{$(g.nDiv).hide();$(g.nBtn).hide();this.hset=$(this.hDiv).offset();this.hset.right=this.hset.left+$('table',this.hDiv).width();this.hset.bottom=this.hset.top+$('table',this.hDiv).height();this.dcol=obj;this.dcoln=$('th',this.hDiv).index(obj);this.colCopy=document.createElement("div");this.colCopy.className="colCopy";this.colCopy.innerHTML=obj.innerHTML;if($.browser.msie){this.colCopy.className="colCopy ie";}
$(this.colCopy).css({position:'absolute','float':'left',display:'none',textAlign:obj.align});$('body').append(this.colCopy);$(this.cDrag).hide();}
$('body').noSelect();},reSize:function(){this.gDiv.style.width=p.width;this.bDiv.style.height=p.height;},dragMove:function(e){if(this.colresize)
{var n=this.colresize.n;var diff=e.pageX-this.colresize.startX;var nleft=this.colresize.ol+diff;var nw=this.colresize.ow+diff;if(nw>p.minwidth){$('div:eq('+n+')',this.cDrag).css('left',nleft);this.colresize.nw=nw;}}
else if(this.vresize)
{var v=this.vresize;var y=e.pageY;var diff=y-v.sy;if(!p.defwidth)p.defwidth=p.width;if(p.width!='auto'&&!p.nohresize&&v.hgo){var x=e.pageX;var xdiff=x-v.sx;var newW=v.w+xdiff;if(newW>p.defwidth){this.gDiv.style.width=newW+'px';p.width=newW;}}
var newH=v.h+diff;if((newH>p.minheight||p.height<p.minheight)&&!v.hgo){this.bDiv.style.height=newH+'px';p.height=newH;this.fixHeight(newH);}
v=null;}
else if(this.colCopy){$(this.dcol).addClass('thMove').removeClass('thOver');if(e.pageX>this.hset.right||e.pageX<this.hset.left||e.pageY>this.hset.bottom||e.pageY<this.hset.top){$('body').css('cursor','move');}
else
$('body').css('cursor','pointer');$(this.colCopy).css({top:e.pageY+10,left:e.pageX+20,display:'block'});}},dragEnd:function(){if(this.colresize){var n=this.colresize.n;var nw=this.colresize.nw;$('th:visible:eq('+n+') div',this.hDiv).css('width',nw);$('tr',this.bDiv).each(function(){$('td:visible div:eq('+n+')',this).css('width',nw);});this.hDiv.scrollLeft=this.bDiv.scrollLeft;$('div:eq('+n+')',this.cDrag).siblings().show();$('.dragging',this.cDrag).removeClass('dragging');this.rePosDrag();this.fixHeight();this.colresize=false;}
else if(this.vresize){this.vresize=false;}
else if(this.colCopy){$(this.colCopy).remove();if(this.dcolt!=null){if(this.dcoln>this.dcolt)
{$('th:eq('+this.dcolt+')',this.hDiv).before(this.dcol);}
else
{$('th:eq('+this.dcolt+')',this.hDiv).after(this.dcol);}
this.switchCol(this.dcoln,this.dcolt);$(this.cdropleft).remove();$(this.cdropright).remove();this.rePosDrag();}
this.dcol=null;this.hset=null;this.dcoln=null;this.dcolt=null;this.colCopy=null;$('.thMove',this.hDiv).removeClass('thMove');$(this.cDrag).show();}
$('body').css('cursor','default');$('body').noSelect(false);},toggleCol:function(cid,visible){var ncol=$("th[axis='col"+cid+"']",this.hDiv)[0];var n=$('thead th',g.hDiv).index(ncol);var cb=$('input[value='+cid+']',g.nDiv)[0];if(visible==null){if(ncol.hide==null){visible=ncol.hideForSelect;}else{visible=ncol.hide}}
if($('input:checked',g.nDiv).length<p.minColToggle&&!visible)return false;if(visible){ncol.hide=false;$(ncol).show();cb.checked=true;}
else{ncol.hide=true;$(ncol).hide();cb.checked=false;}
$('tbody tr',t).each
(function(){if(visible)
$('td:eq('+n+')',this).show();else
$('td:eq('+n+')',this).hide();});this.rePosDrag();if(p.onToggleCol)p.onToggleCol(cid,visible);return visible;},switchCol:function(cdrag,cdrop){$('tbody tr',t).each
(function(){if(cdrag>cdrop)
$('td:eq('+cdrop+')',this).before($('td:eq('+cdrag+')',this));else
$('td:eq('+cdrop+')',this).after($('td:eq('+cdrag+')',this));});if(cdrag>cdrop)
$('tr:eq('+cdrop+')',this.nDiv).before($('tr:eq('+cdrag+')',this.nDiv));else
$('tr:eq('+cdrop+')',this.nDiv).after($('tr:eq('+cdrag+')',this.nDiv));if($.browser.msie&&$.browser.version<7.0)$('tr:eq('+cdrop+') input',this.nDiv)[0].checked=true;this.hDiv.scrollLeft=this.bDiv.scrollLeft;},scroll:function(){this.hDiv.scrollLeft=this.bDiv.scrollLeft;this.rePosDrag();},hideLoading:function(){if(p.usepager){$('.pReload',this).removeClass('loading');}
if(p.hideOnSubmit)$(g.block).remove();if(p.usepager){$('.pPageStat',this).html(p.errormsg);}
this.loading=false;},addData:function(data){if(p.preProcess)
{data=p.preProcess(data);}
if(p.usepager){$('.pReload',this.pDiv).removeClass('loading');}
this.loading=false;if(!data){if(p.usepager){$('.pPageStat',this.pDiv).html(p.errormsg);}
return false;}
var temp=p.total;if(p.dataType=='xml'){p.total=+$('rows total',data).text();}
else{p.total=data.total;}
if(p.total<0){p.total=temp;}
if(p.total==0){$('tr, a, td, div',t).unbind();$(t).empty();p.pages=1;p.page=1;if(p.usepager){this.buildpager();$('.pPageStat',this.pDiv).html(p.nomsg);}
var _ths=$('thead tr:first th',g.hDiv);var _thsLen=_ths.length;var _nDivTds=$('tbody tr td:odd',g.nDiv);$(_ths).each(function(_j){var _idx=$(this).attr('axis').substr(3);if(_idx=="-1"){_thsLen--;}else{var _nDivTd=null;if(_nDivTds&&_nDivTds.length==_thsLen){_nDivTd=_nDivTds[_idx];}
var cm=p.colModel[_idx];if(cm.dynTitle==true&&data.titles!=null&&data.titles[_idx]!=null){var _title=data.titles[_idx];$(this).find('div').text(_title);if(_nDivTd){$(_nDivTd).text(_title);}}}});if(p.hideOnSubmit){$(g.block).remove();}
return false;}
p.pages=Math.ceil(p.total/p.rp);if(p.dataType=='xml')
{p.page=+$('rows page',data).text();}
else
{p.page=data.page;}
if(p.usepager){this.buildpager();}
var ths=$('thead tr:first th',g.hDiv);var _thsLen=ths.length;var thsdivs=$('thead tr:first th div',g.hDiv);var nDivTds=$('tbody tr td:odd',g.nDiv);var tbhtml=[];var _createTbody=true;if(p.appendData){var hasData=$(t).find('tbody').length;if(hasData!=0){_createTbody=false;}}
if(_createTbody){tbhtml.push("<tbody>");}
if(p.dataType=='json'){if(data.rows!=null){$.each(data.rows,function(i,row){if(row.cell==null){return;}
tbhtml.push("<tr id='","row",row.id,"'");if(i%2&&p.striped){tbhtml.push(" class='erow'");}
if(p.rowbinddata){tbhtml.push("ch='",g.htmlDecode(row.cell.join("_FG$SP_")),"'");}
tbhtml.push(">");var trid=row.id;$(ths).each(function(j){var tddata="";var tdclass="";tbhtml.push("<td align='",this.align,"'");var idx=$(this).attr('axis').substr(3);if(p.sortname&&p.sortname==$(this).attr('abbr')){tdclass='sorted';}
if(this.hide||this.hideForSelect){tbhtml.push(" style='display:none;'");}
var width=thsdivs[j].style.width;var div=[];div.push("<div style='text-align:",this.align,";width:",width,";");if(p.nowrap==false){div.push("white-space:normal; height:auto;");div.push("'>");}else{div.push("'");div.push("");div.push(">");}
if(idx=="-1"){if(p.showcheckbox){div.push("<input style='margin-top:3px;' type='checkbox' id='chk_",row.id,"' class='itemchk' value='",row.id,"' name='"+p.checkboxName+"'/>");}
else if(p.showradio){div.push("<input style='margin-top:3px;' type='radio' id='chk_",row.id,"' class='itemchk' value='",row.id,"' name='"+p.radioName+"'/>");}
if(tdclass!=""){tdclass+=" chboxtd";}else{tdclass+="chboxtd";}
_thsLen--;}
else{var _nDivTd=null;if(nDivTds&&nDivTds.length==_thsLen){_nDivTd=nDivTds[j];}
var _th=$(this);var _hasVal=false;var _inner=null;if((p.colModel&&idx<p.colModel.length)&&(data.rawRecords&&data.rawRecords.length!=0)){var cm=p.colModel[idx],colArray=cm.name.split("."),_record=data.rawRecords[i];if(colArray.length>1){if(_record[colArray[0]]!=null){_inner=_record[colArray[0]][colArray[1]];_hasVal=true;}}else{if(_record[cm.name]!=null){_inner=_record[cm.name];_hasVal=true;}}
if(cm.dynTitle==true&&data.titles!=null&&data.titles[idx]!=null){var _title=data.titles[idx];_th.find('div').text(_title);if(_nDivTd){$(_nDivTd).text(_title);}}}
if(!_hasVal&&idx<row.cell.length){}
if(this.optType=="optBtn"){$.each(eval(this.optDetail),function(i,optObj){var disbaledAttr="";if(optObj.optAuthFlag=="false"){disbaledAttr="disabled='disabled'";var splIndex=optObj.optImage.lastIndexOf(".");optObj.optImage=optObj.optImage.substring(0,splIndex)+"_disabled"+optObj.optImage.substring(splIndex);}
div.push("<a "+disbaledAttr+" onclick='"+optObj.optMethod+"(\""+_inner+"\")' style='cursor:pointer;'>");div.push("<img src='"+optObj.optImage+"' width='16' title='"+optObj.optTip+"' height='16'></img>");div.push("</a>");div.push("&nbsp;&nbsp;");});}else if(this.optType=="optLink"){$.each(eval(this.optDetail),function(i,optObj){div.push("<a onclick='"+optObj.optMethod+"(\""+_inner+"\")' style='cursor:pointer;'>");div.push(optObj.optTip);div.push("</a>");div.push("&nbsp;&nbsp;");});}else{var divInner=_inner;if(this.process){var _row=data.rawRecords[i];divInner=this.process(divInner,trid,_row);}
else if(p.nowrap==true&&typeof(divInner)==="string"&&p.m_length!=0&&divInner.length>p.m_length){$.each(div,function(i,v){if(v==""){div[i]=" title='"+g.htmlDecode(divInner)+"'";return false;}});}
div.push(divInner);}}
div.push("</div>");if(tdclass!=""){tbhtml.push(" class='",tdclass,"'");}
tbhtml.push(">",div.join(""),"</td>");});tbhtml.push("</tr>");});}}else if(p.dataType=='xml'){i=1;$("rows row",data).each
(function(){i++;var robj=this;var arrdata=new Array();$("cell",robj).each(function(){arrdata.push($(this).text());});var nid=$(this).attr('id');tbhtml.push("<tr id='","row",nid,"'");if(i%2&&p.striped){tbhtml.push(" class='erow'");}
if(p.rowbinddata){tbhtml.push("ch='",arrdata.join("_FG$SP_"),"'");}
tbhtml.push(">");var trid=nid;$(ths).each(function(j){tbhtml.push("<td align='",this.align,"'");if(this.hide){tbhtml.push(" style='display:none;vertical-align:middle;'");}
var tdclass="";var tddata="";var idx=$(this).attr('axis').substr(3);if(p.sortname&&p.sortname==$(this).attr('abbr')){tdclass='sorted';}
var width=thsdivs[j].style.width;var div=[];div.push("<div style='text-align:",this.align,";width:",width,";");if(p.nowrap==false){div.push("white-space:normal;height:auto;");}
div.push("'>");if(idx=="-1"){if(p.showcheckbox){div.push("<input type='checkbox' id='chk_",nid,"' class='itemchk' value='",nid,"' name='"+p.checkboxName+"'/>");}
else if(p.showradio){div.push("<input type='radio' id='chk_",nid,"' class='itemchk' value='",nid,"' name='"+p.radioName+"'/>");}
if(tdclass!=""){tdclass+=" chboxtd";}else{tdclass+="chboxtd";}}
else{var divInner=arrdata[idx]||"&nbsp;";if(p.rowbinddata){tddata=arrdata[idx]||"";}
if(this.process){divInner=this.process(divInner,trid);}
div.push(divInner);}
div.push("</div>");if(tdclass!=""){tbhtml.push(" class='",tdclass,"'");}
tbhtml.push(" axis='",tddata,"'",">",div.join(""),"</td>");});tbhtml.push("</tr>");});}
if(_createTbody){tbhtml.push("</tbody>");$(t).html(tbhtml.join(""));}else{$(t).find("tr:last").after(tbhtml.join(""));}
this.addRowProp();if(p.onSuccess)p.onSuccess(data);if(p.hideOnSubmit)$(g.block).remove();this.hDiv.scrollLeft=this.bDiv.scrollLeft;if($.browser.opera)$(t).css('visibility','visible');},htmlDecode:function(val){if(val){return val.replace(/'/g,'&apos;').replace(/"/g,'&amp;');}},changeSort:function(th){if(this.loading)return true;$(g.nDiv).hide();$(g.nBtn).hide();if(p.sortname==$(th).attr('abbr')){if(p.sortorder=='asc')p.sortorder='desc';else p.sortorder='asc';}
$(th).addClass('sorted').siblings().removeClass('sorted');$('.sdesc',this.hDiv).removeClass('sdesc');$('.sasc',this.hDiv).removeClass('sasc');$('div',th).addClass('s'+p.sortorder);p.sortname=$(th).attr('abbr');if(p.onChangeSort)
p.onChangeSort(p.sortname,p.sortorder);else
this.populate();},buildpager:function(){$('.pcontrol input',this.pDiv).val(p.page);$('.pcontrol span',this.pDiv).html(p.pages);var r1=(p.page-1)*p.rp+1;var r2=r1+p.rp-1;if(p.total<r2)r2=p.total;var stat=p.pagestat;stat=stat.replace(/{from}/,r1);stat=stat.replace(/{to}/,r2);stat=stat.replace(/{total}/,p.total);$('.pPageStat',this.pDiv).html(stat);},populate:function(){if(this.loading)return true;if(p.onSubmit){var gh=p.onSubmit();if(!gh){this.loading=false;return false;}}
this.loading=true;if(!p.url){this.loading=false;return false;}
$(g.hDiv).find(".noborder").attr("checked",false);if(p.usepager){$('.pPageStat',this.pDiv).html(p.procmsg);$('.pReload',this.pDiv).addClass('loading');$(g.block).css({top:g.bDiv.offsetTop});if(p.hideOnSubmit)$(this.gDiv).prepend(g.block);if($.browser.opera)$(t).css('visibility','hidden');if(!p.newp)p.newp=1;if(p.page>p.pages)p.page=p.pages;}
var param=[{name:'page',value:p.newp},{name:'rp',value:p.rp},{name:'sortname',value:p.sortname},{name:'sortorder',value:p.sortorder},{name:'query',value:p.query},{name:'qtype',value:p.qtype},{name:'qop',value:p.qop}];if(p.extParam){for(var pi=0;pi<p.extParam.length;pi++)param[param.length]=p.extParam[pi];}
$.ajax({type:p.method,url:p.url,data:param,dataType:p.dataType,success:function(data){if(data!=null&&data.success==false){g.hideLoading();message({data:data});}else{g.addData(data);}},error:function(data){try{if(p.onError){p.onError(data);}else{message({html:i18n_flexigrid_queryError,showConfirm:true});}g.hideLoading();}catch(e){}},complete:function(response,status){}});},doSearch:function(){var queryType=$('select[name=qtype]',g.sDiv).val();var qArrType=queryType.split("$");var index=-1;if(qArrType.length!=3){p.qop="Eq";p.qtype=queryType;}
else{p.qop=qArrType[1];p.qtype=qArrType[0];index=parseInt(qArrType[2]);}
p.query=$('input[name=q]',g.sDiv).val();if(p.query!=""&&p.searchitems&&index>=0&&p.searchitems.length>index){if(p.searchitems[index].reg){if(!p.searchitems[index].reg.test(p.query)){alert("你的输入不符合要求!");return;}}}
p.newp=1;this.populate();},changePage:function(ctype){if(this.loading)return true;switch(ctype){case'first':p.newp=1;break;case'prev':if(p.page>1)p.newp=parseInt(p.page)-1;break;case'next':if(p.page<p.pages)p.newp=parseInt(p.page)+1;break;case'last':p.newp=p.pages;break;case'input':var nv=parseInt($('.pcontrol input',this.pDiv).val());if(isNaN(nv))nv=1;if(nv<1)nv=1;else if(nv>p.pages)nv=p.pages;$('.pcontrol input',this.pDiv).val(nv);p.newp=nv;break;}
if(p.newp==p.page)return false;$(g.hDiv).find(".noborder").attr("checked",false);if(p.onChangePage)
p.onChangePage(p.newp);else
this.populate();},cellProp:function(n,ptr,pth){var tdDiv=document.createElement('div');if(pth!=null){if(p.sortname==$(pth).attr('abbr')&&p.sortname){this.className='sorted';}
$(tdDiv).css({textAlign:pth.align,width:$('div:first',pth)[0].style.width});if(pth.hide)$(this).css('display','none');}
if(p.nowrap==false)$(tdDiv).css({'white-space':'normal','height':'auto'});if(this.innerHTML=='')this.innerHTML='&nbsp;';tdDiv.innerHTML=this.innerHTML;var prnt=$(this).parent()[0];var pid=false;if(prnt.id)pid=prnt.id.substr(3);if(pth!=null){if(pth.process)
{pth.process(tdDiv,pid);}}
$("input.itemchk",tdDiv).each(function(){$(this).click(function(){if(this.checked){if(p.showcheckbox){if(this.checked){$(ptr).addClass("trSelected");}else{$(ptr).removeClass("trSelected");}}
else if(p.showradio){$(ptr).parent().children("tr").removeClass("trSelected");$(ptr).addClass("trSelected");}}
else{$(ptr).removeClass("trSelected");}
if(p.onrowchecked){p.onrowchecked.call(this);}});});$(this).empty().append(tdDiv).removeAttr('width');},addCellProp:function(){var $gF=this.cellProp;$('tbody tr td',g.bDiv).each
(function(){var n=$('td',$(this).parent()).index(this);var pth=$('th:eq('+n+')',g.hDiv).get(0);var ptr=$(this).parent();$gF.call(this,n,ptr,pth);});$gF=null;},getCheckedRows:function(){var ids=[];$(":checkbox:checked",g.bDiv).each(function(){ids.push($(this).val());});return ids;},getCellDim:function(obj)
{var ht=parseInt($(obj).height());var pht=parseInt($(obj).parent().height());var wt=parseInt(obj.style.width);var pwt=parseInt($(obj).parent().width());var top=obj.offsetParent.offsetTop;var left=obj.offsetParent.offsetLeft;var pdl=parseInt($(obj).css('paddingLeft'));var pdt=parseInt($(obj).css('paddingTop'));return{ht:ht,wt:wt,top:top,left:left,pdl:pdl,pdt:pdt,pht:pht,pwt:pwt};},rowProp:function(){if(p.rowhandler){p.rowhandler(this);}
if($.browser.msie&&$.browser.version<7.0){$(this).hover(function(){$(this).addClass('trOver');},function(){$(this).removeClass('trOver');});}},addRowProp:function(){var $gF=this.rowProp;$('tbody tr',g.bDiv).each(function(){$("input.itemchk",this).each(function(){var ptr=$(this).parent().parent().parent();$(this).click(function(){if(p.showcheckbox){if(this.checked){$(ptr).addClass("trSelected");}else{$(ptr).removeClass("trSelected");}}
else if(p.showradio){$(ptr).parent().children("tr").removeClass("trSelected");$(ptr).addClass("trSelected");}
if(this.checked)
{var ptable=$(this).parent().parent().parent().parent().parent();var checkLength=$(ptable).find('.chboxtd input:checked:not([disabled])').length;if($(ptable).find(".chboxtd input[type='checkbox']:not([disabled])").length==checkLength)
{$(g.hDiv).find(".cth input[type='checkbox']").attr("checked",true);}}
else
{$(g.hDiv).find(".cth input[type='checkbox']").attr("checked",false);}
if(p.onrowchecked){p.onrowchecked.call(this);}});});$gF.call(this);});$gF=null;},checkAllOrNot:function(parent){var ischeck=$(this).attr("checked");$('tbody tr',g.bDiv).each(function(){if(ischeck){$(this).addClass("trSelected");}
else{$(this).removeClass("trSelected");}});$("input.itemchk",g.bDiv).each(function(){this.checked=ischeck;if(p.onrowchecked){p.onrowchecked.call(this);}});},pager:0};if(p.colModel){thead=document.createElement('thead');tr=document.createElement('tr');if(p.showcheckbox){var cth=jQuery('<th/>');var cthch=jQuery('<input style="margin-top:2px;" type="checkbox" title="'+p.numCheckBoxTitle+'"/>');cthch.addClass("noborder")
cth.addClass("cth").attr({'axis':"col-1",width:"40",align:"center","isch":true}).append(cthch);$(tr).append(cth);}
else if(p.showradio){var cth=jQuery('<th/>');cth.addClass("cth").attr({'axis':"col-1",width:"40",align:"center","isch":true});$(tr).append(cth);}
for(i=0;i<p.colModel.length;i++){var cm=p.colModel[i];var th=document.createElement('th');th.innerHTML=cm.display;if(cm.unit){th.innerHTML+=cm.unit;}
if(cm.name&&cm.sortable)
$(th).attr('abbr',cm.name);if(cm.optType){$(th).attr('optType',cm.optType);}
if(cm.optDetail){$(th).attr('optDetail',cm.optDetail);}
if(cm.hideForSelect){$(th).attr('hideForSelect',cm.hideForSelect);}
$(th).attr('axis','col'+i);if(cm.align)
th.align=cm.align;if(cm.width)
$(th).attr('width',cm.width);if(cm.hide){th.hide=true;}
if(cm.hideForSelect){th.hideForSelect=true;}
if(cm.toggle!=undefined){th.toggle=cm.toggle}
if(cm.process){th.process=cm.process;}
$(tr).append(th);}
$(thead).append(tr);$(t).prepend(thead);}
g.gDiv=document.createElement('div');g.mDiv=document.createElement('div');g.hDiv=document.createElement('div');g.bDiv=document.createElement('div');g.vDiv=document.createElement('div');g.rDiv=document.createElement('div');g.cDrag=document.createElement('div');g.block=document.createElement('div');g.nDiv=document.createElement('div');g.nBtn=document.createElement('div');g.iDiv=document.createElement('div');g.tDiv=document.createElement('div');g.sDiv=document.createElement('div');if(p.usepager)g.pDiv=document.createElement('div');g.hTable=document.createElement('table');g.gDiv.className=p.gridClass;if(p.width!='auto')g.gDiv.style.width=p.width+'px';if($.browser.msie)
$(g.gDiv).addClass('ie');if(p.novstripe)
$(g.gDiv).addClass('novstripe');$(t).before(g.gDiv);$(g.gDiv).append(t);if(p.buttons){g.tDiv.className='tDiv';var tDiv2=document.createElement('div');tDiv2.className='tDiv2';for(i=0;i<p.buttons.length;i++){var btn=p.buttons[i];if(!btn.separator){var btnDiv=document.createElement('div');btnDiv.className='fbutton';btnDiv.innerHTML="<div><span>"+btn.displayname+"</span></div>";if(btn.title){btnDiv.title=btn.title;}
if(btn.bclass)
$('span',btnDiv).addClass(btn.bclass);btnDiv.onpress=btn.onpress;btnDiv.name=btn.name;if(btn.onpress){$(btnDiv).click
(function(){this.onpress(this.name,g.gDiv);});}
$(tDiv2).append(btnDiv);if($.browser.msie&&$.browser.version<7.0){$(btnDiv).hover(function(){$(this).addClass('fbOver');},function(){$(this).removeClass('fbOver');});}}else{$(tDiv2).append("<div class='btnseparator'></div>");}}
$(g.tDiv).append(tDiv2);$(g.tDiv).append("<div style='clear:both'></div>");$(g.gDiv).prepend(g.tDiv);}
g.hDiv.className='hDiv';$(t).before(g.hDiv);g.hTable.cellPadding=0;g.hTable.cellSpacing=0;$(g.hDiv).append('<div class="hDivBox"></div>');$('div',g.hDiv).append(g.hTable);var thead=$("thead:first",t).get(0);if(thead)$(g.hTable).append(thead);thead=null;if(!p.colmodel)var ci=0;$('thead tr:first th',g.hDiv).each
(function(){var thdiv=document.createElement('div');if($(this).attr('abbr')){$(this).click(function(e){if(!$(this).hasClass('thOver'))return false;var obj=(e.target||e.srcElement);if(obj.href||obj.type)return true;g.changeSort(this);});if($(this).attr('abbr')==p.sortname){this.className='sorted';thdiv.className='s'+p.sortorder;}}
if(this.hide||this.hideForSelect)$(this).hide();if(!p.colmodel&&!$(this).attr("isch")){$(this).attr('axis','col'+ci++);}
$(thdiv).css({textAlign:this.align,width:this.width+'px'});thdiv.innerHTML=this.innerHTML;$(this).empty().append(thdiv).removeAttr('width');if(!$(this).attr("isch")&&p.isDragCol){$(this).mousedown(function(e){g.dragStart('colMove',e,this);}).hover(function(){if(!g.colresize&&!$(this).hasClass('thMove')&&!g.colCopy)$(this).addClass('thOver');if($(this).attr('abbr')!=p.sortname&&!g.colCopy&&!g.colresize&&$(this).attr('abbr'))$('div',this).addClass('s'+p.sortorder);else if($(this).attr('abbr')==p.sortname&&!g.colCopy&&!g.colresize&&$(this).attr('abbr')){var no='';if(p.sortorder=='asc')no='desc';else no='asc';$('div',this).removeClass('s'+p.sortorder).addClass('s'+no);}
if(g.colCopy){var n=$('th',g.hDiv).index(this);if(n==g.dcoln)return false;if(n<g.dcoln)$(this).append(g.cdropleft);else $(this).append(g.cdropright);g.dcolt=n;}else if(!g.colresize){var thsa=$('th:visible',g.hDiv);var nv=-1;for(var i=0,j=0,l=thsa.length;i<l;i++){if($(thsa[i]).css("display")!="none"){if(thsa[i]==this){nv=j;break;}
j++;}}
var onl=parseInt($('div:eq('+nv+')',g.cDrag).css('left'));var nw=parseInt($(g.nBtn).width())+parseInt($(g.nBtn).css('borderLeftWidth'));nl=onl-nw+Math.floor(p.cgwidth/2);$(g.nDiv).hide();$(g.nBtn).hide();if(p.isColSel)
{$(g.nBtn).css({'height':$(g.hDiv).height()});$('div',g.nBtn).css({'height':$(g.hDiv).height()});$(g.nBtn).css({'left':nl,top:g.hDiv.offsetTop}).show();}
var ndw=parseInt($(g.nDiv).width());$(g.nDiv).css({top:g.bDiv.offsetTop});if((nl+ndw)>$(g.gDiv).width())
$(g.nDiv).css('left',onl-ndw+1);else
$(g.nDiv).css('left',nl);if($(this).hasClass('sorted'))
$(g.nBtn).addClass('srtd');else
$(g.nBtn).removeClass('srtd');}},function(){$(this).removeClass('thOver');if($(this).attr('abbr')!=p.sortname)$('div',this).removeClass('s'+p.sortorder);else if($(this).attr('abbr')==p.sortname&&typeof(p.sortname)!='undefined'){var no='';if(p.sortorder=='asc')no='desc';else no='asc';$('div',this).addClass('s'+p.sortorder).removeClass('s'+no);}
if(g.colCopy){$(g.cdropleft).remove();$(g.cdropright).remove();g.dcolt=null;}});}});g.bDiv.className='bDiv';$(t).before(g.bDiv);$(g.bDiv).css({height:(p.height=='auto')?'auto':p.height+"px"}).scroll(function(e){g.scroll()}).append(t);if(p.height=='auto'){$('table',g.bDiv).addClass('autoht');}
if(p.url==false||p.url==""){g.addCellProp();g.addRowProp();}
var cdcol=$('thead tr:first th:first',g.hDiv).get(0);if(cdcol!=null){g.cDrag.className='cDrag';g.cdpad=0;g.cdpad+=(isNaN(parseInt($('div',cdcol).css('borderLeftWidth')))?0:parseInt($('div',cdcol).css('borderLeftWidth')));g.cdpad+=(isNaN(parseInt($('div',cdcol).css('borderRightWidth')))?0:parseInt($('div',cdcol).css('borderRightWidth')));g.cdpad+=(isNaN(parseInt($('div',cdcol).css('paddingLeft')))?0:parseInt($('div',cdcol).css('paddingLeft')));g.cdpad+=(isNaN(parseInt($('div',cdcol).css('paddingRight')))?0:parseInt($('div',cdcol).css('paddingRight')));g.cdpad+=(isNaN(parseInt($(cdcol).css('borderLeftWidth')))?0:parseInt($(cdcol).css('borderLeftWidth')));g.cdpad+=(isNaN(parseInt($(cdcol).css('borderRightWidth')))?0:parseInt($(cdcol).css('borderRightWidth')));g.cdpad+=(isNaN(parseInt($(cdcol).css('paddingLeft')))?0:parseInt($(cdcol).css('paddingLeft')));g.cdpad+=(isNaN(parseInt($(cdcol).css('paddingRight')))?0:parseInt($(cdcol).css('paddingRight')));$(g.bDiv).before(g.cDrag);var cdheight=$(g.bDiv).height();var hdheight=$(g.hDiv).height();$(g.cDrag).css({top:-hdheight+'px'});if(p.isDragCol){$('thead tr:first th',g.hDiv).each
(function(){var cgDiv=document.createElement('div');$(g.cDrag).append(cgDiv);if(!p.cgwidth)p.cgwidth=$(cgDiv).width();$(cgDiv).css({height:cdheight+hdheight}).mousedown(function(e){g.dragStart('colresize',e,this);});if($.browser.msie&&$.browser.version<7.0){g.fixHeight($(g.gDiv).height());$(cgDiv).hover(function(){g.fixHeight();$(this).addClass('dragging')},function(){if(!g.colresize)$(this).removeClass('dragging')});}});}}
if(p.striped)
$('tbody tr:odd',g.bDiv).addClass('erow');if(p.resizable&&p.height!='auto'){g.vDiv.className='vGrip';$(g.vDiv).mousedown(function(e){g.dragStart('vresize',e)}).html('<span></span>');$(g.bDiv).after(g.vDiv);}
if(p.resizable&&p.width!='auto'&&!p.nohresize){g.rDiv.className='hGrip';$(g.rDiv).mousedown(function(e){g.dragStart('vresize',e,true);}).html('<span></span>').css('height',$(g.gDiv).height());if($.browser.msie&&$.browser.version<7.0){$(g.rDiv).hover(function(){$(this).addClass('hgOver');},function(){$(this).removeClass('hgOver');});}
$(g.gDiv).append(g.rDiv);}
if(p.usepager){g.pDiv.className='pDiv';g.pDiv.innerHTML='<div class="pDiv2"></div>';$(g.bDiv).after(g.pDiv);var html='<div class="pGroup"><div class="pFirst pButton" title="'+i18n_flexigrid_toFirstPage+'"><span></span></div><div class="pPrev pButton" title="'+i18n_flexigrid_toPreviousPage+'"><span></span></div> </div><div class="btnseparator"></div> <div class="pGroup"><span class="pcontrol">'+i18n_flexigrid_currentPage+'<input class="ui-corner-all" style="border:1px solid #d4d0c8;width:30px;margin-top:4px;background: #fff; height:16px; line-height:16px;" size="1" value="1" />&nbsp;'+i18n_flexigrid_totalPage+'<span> 1 </span></span></div><div class="btnseparator"></div><div class="pGroup"> <div class="pNext pButton" title="'+i18n_flexigrid_toNextPage+'"><span></span></div><div class="pLast pButton" title="'+i18n_flexigrid_toLastPage+'"><span></span></div></div><div class="btnseparator"></div><div class="pGroup"> <div class="pReload pButton" title="'+i18n_flexigrid_refresh+'"><span></span></div> </div> <div class="btnseparator"></div><div class="pGroup"> <div class="pReloadGo pButton" ><span></span></div> </div> <div class="btnseparator"></div><div class="pGroup"><span class="pPageStat"></span></div>';$('div',g.pDiv).html(html);$('.pReloadGo',g.pDiv).click(function(){g.changePage('input');});$('.pReload',g.pDiv).click(function(){g.populate();});$('.pFirst',g.pDiv).click(function(){g.changePage('first');});$('.pPrev',g.pDiv).click(function(){g.changePage('prev');});$('.pNext',g.pDiv).click(function(){g.changePage('next');});$('.pLast',g.pDiv).click(function(){g.changePage('last');});$('.pcontrol input',g.pDiv).keydown(function(e){if(e.keyCode==13)g.changePage('input')});if($.browser.msie&&$.browser.version<7)$('.pButton',g.pDiv).hover(function(){$(this).addClass('pBtnOver');},function(){$(this).removeClass('pBtnOver');});if(p.useRp){var opt="";for(var nx=0;nx<p.rpOptions.length;nx++){if(p.rp==p.rpOptions[nx])sel='selected="selected"';else sel='';opt+="<option value='"+p.rpOptions[nx]+"' "+sel+" >"+p.rpOptions[nx]+"&nbsp;&nbsp;</option>";};$('.pDiv2',g.pDiv).prepend("<div class='pGroup'>"+i18n_flexigrid_everyPageCount+"<select name='rp' class='ui-corner-all' style='margin-top:3px;'>"+opt+"</select></div> <div class='btnseparator'></div>");$('select',g.pDiv).change(function(){if(p.onRpChange)
p.onRpChange(+this.value);else{p.newp=1;p.rp=+this.value;g.populate();}});}
if(p.searchitems){$('.pDiv2',g.pDiv).prepend("<div class='pGroup'> <div class='pSearch pButton'><span></span></div> </div>  <div class='btnseparator'></div>");$('.pSearch',g.pDiv).click(function(){$(g.sDiv).slideToggle('fast',function(){$('.sDiv:visible input:first',g.gDiv).trigger('focus');});});g.sDiv.className='sDiv';sitems=p.searchitems;var sopt="";var op="Eq";for(var s=0;s<sitems.length;s++){if(p.qtype==''&&sitems[s].isdefault==true){p.qtype=sitems[s].name;sel='selected="selected"';}else sel='';if(sitems[s].operater=="Like"){op="Like";}
else{op="Eq";}
sopt+="<option value='"+sitems[s].name+"$"+op+"$"+s+"' "+sel+" >"+sitems[s].display+"&nbsp;&nbsp;</option>";}
if(p.qtype=='')p.qtype=sitems[0].name;$(g.sDiv).append("<div class='sDiv2'>"+i18n_flexigrid_quickSearch+"：<input type='text' size='30' name='q' class='qsbox' /> <select name='qtype'>"+sopt+"</select> <input type='button' name='qclearbtn' value='清空' />&nbsp;&nbsp;<input type='button' name='qsbtn' value='查询' /></div>");$('input[name=qsbtn]',g.sDiv).click(function(){g.doSearch()});$('input[name=q],select[name=qtype]',g.sDiv).keydown(function(e){if(e.keyCode==13)g.doSearch()});$('input[name=qclearbtn]',g.sDiv).click(function(){$('input[name=q]',g.sDiv).val('');p.query='';g.doSearch();});$(g.bDiv).after(g.sDiv);}}
$(g.pDiv,g.sDiv).append("<div style='clear:both'></div>");if(p.title){g.mDiv.className='mDiv';g.mDiv.innerHTML='<div class="ftitle">'+p.title+'</div>';$(g.gDiv).prepend(g.mDiv);if(p.showTableToggleBtn){$(g.mDiv).append('<div class="ptogtitle" title="Minimize/Maximize Table"><span></span></div>');$('div.ptogtitle',g.mDiv).click
(function(){$(g.gDiv).toggleClass('hideBody');$(this).toggleClass('vsble');});}}
g.cdropleft=document.createElement('span');g.cdropleft.className='cdropleft';g.cdropright=document.createElement('span');g.cdropright.className='cdropright';g.block.className='gBlock';var blockloading=$("<div/>");blockloading.addClass("loading");$(g.block).append(blockloading);var gh=$(g.bDiv).height();var gtop=g.bDiv.offsetTop;$(g.block).css({width:g.bDiv.style.width,height:gh,position:'relative',marginBottom:(gh*-1),zIndex:1,top:gtop,left:'0px'});$(g.block).fadeTo(0,p.blockOpacity);if($('th',g.hDiv).length){g.nDiv.className='nDiv';g.nDiv.innerHTML="<table cellpadding='0' cellspacing='0'><tbody></tbody></table>";$(g.nDiv).css({marginBottom:(gh*-1),display:'none',top:gtop}).noSelect();var cn=0;$('th div',g.hDiv).each
(function(){var kcol=$("th[axis='col"+cn+"']",g.hDiv)[0];if(kcol==null)return;var chkall=$("input[type='checkbox']",this);if(chkall.length>0){chkall[0].onclick=g.checkAllOrNot;return;}
else{var showradio=$(this).parent().attr("isch");if(showradio=="true"){return;}}
if(kcol.toggle==false||this.innerHTML==""){cn++;return;}
var chk='checked="checked"';if(kcol.style.display=='none')chk='';if(typeof(kcol.hide)!='undefined'||kcol.hide==true){$('tbody',g.nDiv).append('<tr style="display:none"><td class="ndcol1"><input type="checkbox" '+chk+' class="togCol noborder" value="'+cn+'" /></td><td class="ndcol2">'+this.innerHTML+'</td></tr>');}
else{$('tbody',g.nDiv).append('<tr><td class="ndcol1"><input type="checkbox" class="togCol" '+chk+'  value="'+cn+'" /></td><td class="ndcol2">'+this.innerHTML+'</td></tr>');}
cn++;});if($.browser.msie&&$.browser.version<7.0)
$('tr',g.nDiv).hover
(function(){$(this).addClass('ndcolover');},function(){$(this).removeClass('ndcolover');});$('td.ndcol2',g.nDiv).click
(function(){if($('input:checked',g.nDiv).length<=p.minColToggle&&$(this).prev().find('input')[0].checked)return false;return g.toggleCol($(this).prev().find('input').val());});$('input.togCol',g.nDiv).click
(function(){if($('input:checked',g.nDiv).length<p.minColToggle&&this.checked==false)return false;$(this).parent().next().trigger('click');});$(g.gDiv).prepend(g.nDiv);$(g.nBtn).addClass('nBtn').html('<div></div>').click
(function(){$(g.nDiv).toggle();return true;});if(p.showToggleBtn)
$(g.gDiv).prepend(g.nBtn);}
$(g.iDiv).addClass('iDiv').css({display:'none'});$(g.bDiv).append(g.iDiv);$(g.bDiv).hover(function(){$(g.nDiv).hide();$(g.nBtn).hide();},function(){if(g.multisel)g.multisel=false;});$(g.gDiv).hover(function(){},function(){$(g.nDiv).hide();$(g.nBtn).hide();});$(document).mousemove(function(e){g.dragMove(e)}).mouseup(function(e){g.dragEnd()}).hover(function(){},function(){g.dragEnd()});window.movefunction=function(){$(document).mousemove(function(e){g.dragMove(e)}).mouseup(function(e){g.dragEnd()}).hover(function(){},function(){g.dragEnd()});}
if($.browser.msie&&$.browser.version<7.0){$('.hDiv,.bDiv,.mDiv,.pDiv,.vGrip,.tDiv, .sDiv',g.gDiv).css({width:'100%'});$(g.gDiv).addClass('ie6');if(p.width!='auto')$(g.gDiv).addClass('ie6fullwidthbug');}
g.rePosDrag();g.fixHeight();t.p=p;t.grid=g;if(p.url&&p.autoload){g.populate();}
return t;};var docloaded=false;$(document).ready(function(){docloaded=true});$.fn.flexigrid=function(p){return this.each(function(){if(!docloaded){$(this).hide();var t=this;$(document).ready
(function(){$.addFlex(t,p);});}else{$.addFlex(this,p);}});};$.fn.flexReload=function(p){return this.each(function(){if(this.grid&&this.p.url)this.grid.populate();});};$.fn.flexResize=function(w,h){if(typeof(w)==="number"){w=(w+'px');}
if(typeof(h)==="number"){h=(h+'px');}
var p={width:w,height:h};return this.each(function(){if(this.grid){$.extend(this.p,p);this.grid.reSize();}});}
$.fn.ChangePage=function(type){return this.each(function(){if(this.grid){this.grid.changePage(type);}})}
$.fn.flexOptions=function(p){return this.each(function(){if(this.grid)$.extend(this.p,p);});};$.fn.GetOptions=function(){if(this[0].grid){return this[0].p;}
return null;}
$.fn.getCheckedRows=function(){if(this[0].grid){return this[0].grid.getCheckedRows();}
return[];}
$.fn.flexToggleCol=function(cid,visible){return this.each(function(){if(this.grid)this.grid.toggleCol(cid,visible);});};$.fn.flexAddData=function(data){return this.each(function(){if(this.grid)this.grid.addData(data);});};$.fn.noSelect=function(p){if(p==null)
prevent=true;else
prevent=p;if(prevent){return this.each(function(){if($.browser.msie||$.browser.safari)$(this).bind('selectstart',function(){return false;});else if($.browser.mozilla){$(this).css('MozUserSelect','none');$('body').trigger('focus');}
else if($.browser.opera)$(this).bind('mousedown',function(){return false;});else $(this).attr('unselectable','on');});}else{return this.each(function(){if($.browser.msie||$.browser.safari)$(this).unbind('selectstart');else if($.browser.mozilla)$(this).css('MozUserSelect','inherit');else if($.browser.opera)$(this).unbind('mousedown');else $(this).removeAttr('unselectable','on');});}};$.fn.appendData=function(data){return this.each(function(){if(this.grid){var gridData={};if(this.p.total!=null&&this.p.total!=0){gridData.total=this.p.total;}else{gridData.total=data.length;};if(this.p.page!=null&&this.p.page!=0){gridData.page=this.p.page;}else{gridData.page=1;}
gridData.rawRecords=[];gridData.rows=[];var _colModel=this.p.colModel;$.each(data,function(i,cell){if(cell){var row={};row.id=gridData.total+i
row.cell=cell;gridData.rows.push(row);var record={};$.each(_colModel,function(_i,_model){record[_model.name]=cell[_i];});gridData.rawRecords.push(record);}});this.p.appendData=true;this.grid.addData(gridData);}});};$.fn.appendJsonData=function(data){return this.each(function(){if(this.grid&&data.length>0){var gridData={};gridData.total=data.length;if(this.p.page!=null&&this.p.page!=0){gridData.page=this.p.page;}else{gridData.page=1;}
gridData.rawRecords=[];gridData.rows=[];var _colModel=this.p.colModel;$.each(data,function(i,cell){if(cell){var row={};var _cell=[];row.id=gridData.total+i;$.each(_colModel,function(_i,_model){_cell.push(cell[_model.name]);});row.cell=_cell;gridData.rows.push(row);var record={};$.each(_colModel,function(_i,_model){record[_model.name]=cell[_model.name];});gridData.rawRecords.push(record);}});this.p.appendData=false;this.grid.addData(gridData);}});};$.fn.changeHeader=function(index,data){return this.each(function(){if(this.grid){var g=this.grid;var _ths=$('thead tr:first th',g.hDiv);var _thsLen=_ths.length;var _nDivTds=$('tbody tr td:odd',g.nDiv);$(_ths).each(function(_j){var _idx=$(this).attr('axis').substr(3);if(_idx=="-1"){_thsLen--;}else{var _nDivTd=null;if(_nDivTds&&_nDivTds.length==_thsLen){_nDivTd=_nDivTds[_idx];}
if($.isArray(index)){var titles=index;if(titles!=null&&titles[_idx]!=null){var _title=titles[_idx];$(this).find('div').text(_title);if(_nDivTd){$(_nDivTd).text(_title);}}}
else if(index==_idx){var _title=data;$(this).find('div').text(_title);if(_nDivTd){$(_nDivTd).text(_title);}
return false;}}});}});};})(jQuery);